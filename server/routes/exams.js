import express from "express";
import Result from "../models/Result.js";
import Question from "../models/Question.js";
import EssayQuestion from "../models/EssayQuestion.js";
const router = express.Router();
router.post("/obj/submit", async (req,res)=>{ try{ const { pin, studentName, subjectId, answers } = req.body; let objScore=0,objMax=0; for(const a of (answers||[])){ const q = await Question.findById(a.questionId).lean(); if(!q) continue; objMax += 1; if((a.choiceText||'').toString().trim() === (q.correct_answer||'').toString().trim()) objScore += 1; } const r = await Result.create({ pin, studentName, subjectId, objScore, objMax, published:false }); const pct = objMax ? (objScore/objMax)*100 : 0; let message=''; if(pct>=70) message='Excellent work! Very well done — keep it up!'; else if(pct>=50) message='Good job! You passed — keep improving.'; else message='Keep learning — read more and try harder next time.'; res.json({ ok:true, resultId: r._id, objScore, objMax, pct, message, principalName:'Rev. Tamunotonye Chukubereduko S.', principalSignatureUrl:'/assets/principal-signature.png', proprietorName: 'His Lordship, RT. Rev. Dr. Enoch Atuboyedia JP (Bishop, Diocese Of Okrika)', showTheoryAfterSeconds:300 }); } catch(err){ console.error(err); res.status(500).json({ ok:false, error:'Server error' }); } });
router.get("/result/:id", async (req,res)=>{ const r = await Result.findById(req.params.id).lean(); if(!r) return res.status(404).json({ error:'not found' }); r.pct = r.objMax ? (r.objScore/r.objMax)*100 : 0; res.json(r); });
router.get("/essay/bank/:subjectId", async (req,res)=>{ const items = await EssayQuestion.find({ subjectId: req.params.subjectId }).lean(); res.json(items); });
router.post("/admin/essay-mark", async (req,res)=>{ try{ const { resultId, essayScore, essayMax } = req.body; const r = await Result.findById(resultId); if(!r) return res.status(404).json({ error:'not found' }); r.essayScore = Number(essayScore); r.essayMax = Number(essayMax||r.essayMax||0); const totalObtained = (r.objScore||0) + (r.essayScore||0); const totalMax = (r.objMax||0) + (r.essayMax||0); r.overallScore = totalMax ? (totalObtained / totalMax) * 100 : 0; await r.save(); res.json({ ok:true, overallScore: r.overallScore }); } catch(err){ console.error(err); res.status(500).json({ error:'server error' }); } });
export default router;
